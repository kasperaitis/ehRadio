name: Build and Release Firmwares

on:
  push:
    tags:
      - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for contributor config (will abort if builds/owner/platformio.ini does not exist)
        run: |
          if [ ! -f "builds/${{ github.repository_owner }}/platformio.ini" ]; then
            echo "No config found for ${{ github.repository_owner }}. Skipping build."
            exit 1
          fi

      - name: Copy contributor config files to project root
        run: |
          if [ -d "builds/${{ github.repository_owner }}" ]; then
            cp -rf builds/${{ github.repository_owner }}/* .
          fi

      - name: Prepare Gzipped Web Assets for Release
        run: |
          mkdir -p www_release
          for file in data/www/*; do
            filename=$(basename "$file")
            if [[ "$filename" == *.gz ]]; then
              echo "Copying $filename without compression (already gzipped)."
              cp "$file" "www_release/"
            elif [[ "$filename" == "rb_srvrs.json" ]]; then
              echo "Skipping $filename from release assets."
            else
              echo "Compressing $filename."
              gzip -c -9 "$file" > "www_release/$filename.gz"
            fi
          done

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
          
      - name: Extract version
        run: grep '#define RADIOVERSION ' src/core/options.h > version.txt

      - name: Install PlatformIO
        run: pip install platformio

      - name: Make binaries folder to stash .bin files
        run: mkdir -p binaries

      - name: Build all firmwares
        run: pio run

      - name: Rename firmware files with env name
        run: |
          for d in .pio/build/*/ ; do
            env=$(basename "$d")
            if [ -f "$d/firmware.bin" ]; then
              cp "$d/firmware.bin" "binaries/${env}.bin"
            fi
          done

      - name: Save bootloader/partitions for each board environment
        run: |
          # Extract all environments prefixed with 'board' from platformio.ini
          board_envs=$(grep -oP '(?<=\[env:board_)[^\]]+' platformio.ini | tr '\n' ' ')
          echo "Board environments: $board_envs"

          # Iterate over all board environments
          for env in $board_envs; do
            echo "Processing environment: $env"

            # Copy and rename bootloader and partitions binaries
            cp .pio/build/board_$env/bootloader.bin binaries/board_${env}_bootloader.bin
            cp .pio/build/board_$env/partitions.bin binaries/board_${env}_partitions.bin
          done

      - name: Build SPIFFS and extract for each board environment
        run: |
          # Extract all environments prefixed with 'board' from platformio.ini
          board_envs=$(grep -oP '(?<=\[env:board_)[^\]]+' platformio.ini | tr '\n' ' ')
          echo "Board environments: $board_envs"

          # Iterate over all board environments
          for env in $board_envs; do
            echo "Processing environment: $env"

            # Build SPIFFS
            pio run --environment board_$env --target buildfs

            # Copy and rename SPIFFS binaries
            cp .pio/build/board_$env/spiffs.bin binaries/board_${env}_spiffs.bin

          done

      - name: Organize firmware for ESP Web Tools manifests
        run: |
          echo "üì¶ Organizing firmware for manifests..."
          mkdir -p firmware docs/manifests
          
          # Define firmware mapping (board -> firmwares with friendly names)
          # Format: "board_env|chip_family|firmware_env|friendly_name"
          cat > firmware_mapping.txt << 'EOF'
          board_esp32_s3_n16r8|ESP32-S3|esp32_s3_trip5_sh1106_pcm_remote|Trip5 OLED with Remote
          board_esp32_s3_n16r8|ESP32-S3|esp32_s3_trip5_sh1106_pcm_1button|Trip5 OLED with 1-Button
          board_esp32_s3_n16r8|ESP32-S3|esp32_s3_trip5_ssd1306x32_pcm_1button|Trip5 Tiny OLED with 1-Button
          board_esp32_s3_n16r8|ESP32-S3|esp32_s3_trip5_sh1106_vs1053_3buttons|Trip5 OLED with 3-Buttons
          board_esp32_s3_n16r8|ESP32-S3|esp32_s3_trip5_st7735_pcm_1button|Trip5 Color Screen with 1-Button
          board_esp32_s3_n16r8|ESP32-S3|esp32_s3_trip5_ili9488_pcm_1button|Trip5 Big Color Screen with 1-Button
          board_esp32_s3_n16r8|ESP32-S3|esp32_s3_kasperaitis_es3c28p|Kasperaitis ES3C28P
          EOF
          
          # Extract unique board environments
          BOARD_ENVS=$(awk -F'|' '{print $1}' firmware_mapping.txt | sort -u)
          
          # Copy board bootloader/partitions (shared files)
          for board_env in $BOARD_ENVS; do
            echo "üìã Extracting shared files for $board_env..."
            mkdir -p "firmware/$board_env"
            cp "binaries/${board_env}_bootloader.bin" "firmware/$board_env/bootloader.bin"
            cp "binaries/${board_env}_partitions.bin" "firmware/$board_env/partitions.bin"
            echo "‚úÖ $board_env: bootloader + partitions"
          done
          
          # Copy individual firmware binaries
          while IFS='|' read -r board_env chip_family fw_env friendly_name; do
            echo "üì¶ Extracting firmware: $fw_env"
            mkdir -p "firmware/$fw_env"
            if [ -f "binaries/${fw_env}.bin" ]; then
              cp "binaries/${fw_env}.bin" "firmware/$fw_env/firmware.bin"
              echo "‚úÖ $fw_env: firmware.bin"
            else
              echo "‚ùå Warning: firmware.bin not found for $fw_env"
            fi
          done < firmware_mapping.txt
          
          echo "üì¶ Firmware organization complete"

      - name: Generate ESP Web Tools manifests
        run: |
          echo "üìù Generating ESP Web Tools manifests..."
          
          # Generate manifest for each firmware
          while IFS='|' read -r board_env chip_family fw_env friendly_name; do
            echo "Creating manifest for: $friendly_name"
            
            # Determine bootloader offset based on chip family
            BL_OFFSET=4096
            if [[ "$chip_family" == "ESP32-S3" || "$chip_family" == "ESP32-C3" ]]; then
              BL_OFFSET=0
            fi

            manifest_file="docs/manifests/${fw_env}-manifest.json"
            echo '{' > "$manifest_file"
            echo "  \"name\": \"ehRadio - ${friendly_name}\"," >> "$manifest_file"
            echo '  "version": "$(grep -oP '"'"'#define RADIOVERSION "\K[^"]+'"'"' src/core/options.h)",' >> "$manifest_file"
            # To enable "Add to Home Assistant" button, uncomment the line below. 
            # Note: The integration currently requires manual configuration and MQTT.
            # echo '  "home_assistant_domain": "ehradio",' >> "$manifest_file"
            echo '  "funding_url": "https://github.com/sponsors/trip5",' >> "$manifest_file"
            echo '  "builds": [' >> "$manifest_file"
            echo '    {' >> "$manifest_file"
            echo "      \"chipFamily\": \"${chip_family}\"," >> "$manifest_file"
            echo '      "parts": [' >> "$manifest_file"
            echo '        {' >> "$manifest_file"
            echo "          \"path\": \"../firmware/${board_env}/bootloader.bin\"," >> "$manifest_file"
            echo "          \"offset\": ${BL_OFFSET}" >> "$manifest_file"
            echo '        },' >> "$manifest_file"
            echo '        {' >> "$manifest_file"
            echo "          \"path\": \"../firmware/${board_env}/partitions.bin\"," >> "$manifest_file"
            echo '          "offset": 32768' >> "$manifest_file"
            echo '        },' >> "$manifest_file"
            echo '        {' >> "$manifest_file"
            echo "          \"path\": \"../firmware/${fw_env}/firmware.bin\"," >> "$manifest_file"
            echo '          "offset": 65536' >> "$manifest_file"
            echo '        }' >> "$manifest_file"
            echo '      ]' >> "$manifest_file"
            echo '    }' >> "$manifest_file"
            echo '  ]' >> "$manifest_file"
            echo '}' >> "$manifest_file"
            echo "‚úÖ Created $manifest_file"
          done < firmware_mapping.txt
          
          echo "üìù Manifests generated"

      - name: Generate firmware-info.json
        run: |
          echo "üìù Creating firmware-info.json..."
          BUILD_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          VERSION=$(grep -oP '#define RADIOVERSION "\K[^"]+' src/core/options.h)
          
          echo '{' > docs/firmware-info.json
          echo '  "project": "ehRadio",' >> docs/firmware-info.json
          echo "  \"version\": \"${VERSION}\"," >> docs/firmware-info.json
          echo "  \"build_date\": \"${BUILD_DATE}\"," >> docs/firmware-info.json
          echo '  "variants": [' >> docs/firmware-info.json
          
          # Add firmware variants
          FIRST=true
          while IFS='|' read -r board_env chip_family fw_env friendly_name; do
            if [ "$FIRST" = "false" ]; then
              echo "  ," >> docs/firmware-info.json
            fi
            FIRST=false
            
            echo '  {' >> docs/firmware-info.json
            echo "    \"name\": \"${friendly_name}\"," >> docs/firmware-info.json
            echo "    \"manifest\": \"manifests/${fw_env}-manifest.json\"," >> docs/firmware-info.json
            echo "    \"description\": \"ehRadio - ${fw_env}\"" >> docs/firmware-info.json
            echo '  }' >> docs/firmware-info.json
          done < firmware_mapping.txt
          
          echo '  ]' >> docs/firmware-info.json
          echo '}' >> docs/firmware-info.json
          
          echo "‚úÖ firmware-info.json created"
          cat docs/firmware-info.json

      - name: Commit manifests to docs folder
        run: |
          git fetch origin main
          git checkout main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/manifests/*.json docs/firmware-info.json
          git commit -m "Update firmware manifests for $(grep -oP '#define RADIOVERSION "\K[^"]+' src/core/options.h) [skip ci]" || echo "No changes to commit"
          git push origin main || echo "Nothing to push"

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-binaries
          path: |
            firmware/**/*.bin
            docs/firmware-info.json
            docs/manifests/*.json
          retention-days: 90

# Here we also make some OTA-TEST builds (to be deleted later)

#      - name: Prepare TEST-OTA version in options.h
#        run: |
#          # append ‚Äú-OTA-TEST‚Äù inside the quotes of the RADIOVERSION line
#          sed -i '/#define RADIOVERSION/ s/"\([^"]*\)"/"\1-OTA-TEST"/' src/core/options.h

#      - name: Prepare TEST-OTA PlatformIO builds in platformio.ini
#        run: |
#          # for every ‚Äú[env:‚Ä¶]‚Äù line, append ‚Äú_ota_test‚Äù before the closing bracket
#          sed -i '/^\[env:/ s/]/_ota_test]/' platformio.ini
#          # also update any ${env:‚Ä¶‚Äã.lib_deps} macros to include _ota_test
#          sed -Ei 's|\$\{env:([^}]+)\.lib_deps\}|\$\{env:\1_ota_test.lib_deps\}|g' platformio.ini
#          # update any extends = env:‚Ä¶ lines to include _ota_test
#          sed -i 's/^\(extends[[:space:]]*=[[:space:]]*env:[^[:space:]]*\)/\1_ota_test/' platformio.ini

#      - name: Build TEST-OTA firmwares
#        run: pio run

#      - name: Rename firmware files with env name
#        run: |
#          for d in .pio/build/*/ ; do
#            env=$(basename "$d")
#            if [ -f "$d/firmware.bin" ]; then
#              cp "$d/firmware.bin" "binaries/${env}.bin"
#            fi
#          done

# End of OTA-TEST builds

# End of Notes:

#              - the `_ota_test` files are just to show off that online OTA can work
#                - functionally identical to a normal .bin
#                - they have a "fake" version that will allow an update to a normal .bin

      - name: Create ehRadio Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ehRadio ${{ github.ref_name }}
          body: |
            ## Pre-built Firmwares & WebUI Assets
              You can download the firmware and flash yourself or you can use my [Web Installer](https://trip5.github.io/EspHome-Led-Clock/firmware.html).
            ### Notes
              - You can download .bin files and flash to your ESP with `esptool`
              - you will need a firmware file appropriate to your build (see below)
              - depending on your board, choose the appropriate `board_*_bootloader.bin` and `board_*_partitions.bin`
              - for most ESP32s, use:
                - `esptool --chip esp32 --port com14 --baud 460800 write_flash -z 0x1000 board_esp32_bootloader.bin 0x8000 board_esp32_partitions.bin 0x10000 board_esp32.bin`
                - to include spiffs, add this to the above command: `0x390000 board_esp32_spiffs.bin`
              - for ESP32-S3s (like the ESP32-S3-N16R8) use:
                - `esptool --chip esp32s3 --port com14 --baud 460800 write_flash -z 0x0000 board_esp32_s3_n16r8_bootloader.bin 0x8000 board_esp32_s3_n16r8_partitions.bin 0x10000 board_esp32_s3_n16r8.bin`
                - to include spiffs, add this to the above command: `0x670000 board_esp32_s3_n16r8_spiffs.bin`
            ## Boards
              - each of the pre-built board binaries have pre-set hardware configurations, they cannot be changed
              - to view pin usage, click the link and scroll down then click preview
            ### Bare board firmwares (no peripherals, may be used for testing)
              - `board_esp32.bin`
              - `board_esp32_s3_n16r8.bin`
            ### Board Shared Binaries (Bootloader/Partitions)
              - `board_esp32_bootloader.bin` / `board_esp32_partitions.bin` / `board_esp32_spiffs.bin`
              - `board_esp32_s3_n16r8_bootloader.bin` / `board_esp32_s3_n16r8_partitions.bin` / `board_esp32_s3_n16r8_spiffs.bin`
            ### Trip5 Firmwares (all ESP32-S3-N16R8 builds - click for board config)
              - [`esp32_s3_trip5_sh1106_pcm_remote.bin`](https://trip5.github.io/ehRadio_myoptions/generator.html?b=ESP32-S3-DevKitC-1_44Pin&r=72,2,3,4,6,7,15,43,49,51,52,53,54,75,66&i=5,6,15,16,17,22,23,24,25,26,27,28,29,30,39,45,46,47,40&v=42,41,12,11,10,7,18,15,17,16,255,40,39,38,47,21,13,14,8)
              - [`esp32_s3_trip5_sh1106_pcm_1button.bin`](https://trip5.github.io/ehRadio_myoptions/generator.html?b=ESP32-S3-DevKitC-1_44Pin&r=72,2,3,4,6,15,43,49,51,52,53,54,75&i=5,6,15,16,17,22,23,24,25,26,27,28,29,30,39,45,46,47&v=42,41,12,11,10,255,255,255,255,17,255,7,15,16,47,21,13,14)
              - [`esp32_s3_trip5_ssd1306x32_pcm_1button.bin`](https://trip5.github.io/ehRadio_myoptions/generator.html?b=ESP32-S3-DevKitC-1_44Pin&r=72,2,3,4,6,17,43,49,51,52,53,54,75&i=5,6,15,16,17,22,23,24,25,26,27,28,29,30,39,45,46,47&v=42,41,12,11,10,255,255,255,255,17,255,7,15,16,47,21,13,14)
              - [`esp32_s3_trip5_sh1106_vs1053_3buttons.bin`](https://trip5.github.io/ehRadio_myoptions/generator.html?b=ESP32-S3-DevKitC-1_44Pin&r=72,2,3,4,6,15,44,48,49,51,52,53,54,75&i=5,6,18,19,20,21,22,23,24,25,26,27,28,29,30,39,45,46,47&v=42,41,9,14,10,-1,255,255,255,17,18,16,40,39,38,47,21,2,1)
              - [`esp32_s3_trip5_st7735_pcm_1button.bin`](https://trip5.github.io/ehRadio_myoptions/generator.html?b=ESP32-S3-DevKitC-1_44Pin&r=72,2,3,4,6,11,36,43,49,51,52,53,54,75&i=1,2,3,4,15,16,17,22,23,24,25,26,27,28,29,30,39,45,46,47&v=10,9,-1,4,15,7,6,255,255,255,255,42,255,40,39,38,47,21,13,14)
              - [`esp32_s3_trip5_ili9488_pcm_1button.bin`](https://trip5.github.io/ehRadio_myoptions/generator.html?b=ESP32-S3-DevKitC-1_44Pin&r=72,2,3,4,6,31,43,49,51,52,53,54,75&i=1,2,3,4,15,16,17,22,23,24,25,26,27,28,29,30,39,45,46,47&v=10,9,-1,4,15,7,6,255,255,255,255,42,255,40,39,38,47,21,2,1)
            ### Kasperaitis Firmware
              - [`esp32_s3_kasperaitis_es3c28p.bin`](https://www.lcdwiki.com/2.8inch_ESP32-S3_Display) (ES3C28P is a ESP32-S3-N16R8 with 2.8inch Display)
            ### Add Yours
              - you can either fork my `ehradio` repo and edit these files or request a build be added
                - use [the generator](https://trip5.github.io/ehRadio_myoptions/generator.html) and copy the link and include it in your request
            ### Web Assets
              - all other files are needed for the WebUI functionality
              - they are available here to allow automatic downloading to SPIFFS
              - it is NOT necessary to download them (or the SPIFFS bin)
          files: |
            binaries/*.bin
            www_release/*
            version.txt
          fail_on_unmatched_files: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
